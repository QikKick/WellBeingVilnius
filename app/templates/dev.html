<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Walk Map</title>
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
    html, body { height: 100%; margin: 0; background: #0b0b0c; }
    #map { height: 100%; width: 100%; }

    /* Floating controls */
    .controls {
      position: fixed;
      inset: auto 0 var(--safe-bottom, 12px) 0;
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 0 12px;
      pointer-events: none; /* allow map gestures around */
      z-index: 1001; /* sit above Leaflet controls & panes */
    }
    .controls .btn {
      pointer-events: auto;
      -webkit-tap-highlight-color: transparent;
      font: 600 16px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      padding: 14px 16px;
      border-radius: 14px;
      border: none;
      background: rgba(29, 31, 35, 0.9);
      color: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn.primary { background: #1769ff; }
    .btn.danger  { background: #ff3b30; }
    .btn:active { transform: translateY(1px); }
    .hidden { display: none !important; }

    /* Top message bar for status/errors */
    .toast {
      position: fixed;
      top: calc(6px + var(--safe-top, 0px));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(29,31,35,0.95);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      font: 500 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
      z-index: 1000;
      max-width: 92vw;
    }
    .toast.error { background: #c62828; }

    /* Improve touch UX */
    .leaflet-container { touch-action: pan-x pan-y; }

    /* Larger default Leaflet control buttons for mobile */
    .leaflet-control-zoom a { width: 38px; height: 38px; line-height: 38px; }
  </style>
</head>
<body>
  <div id="map" role="application" aria-label="Walking map"></div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <div class="controls">
    <button id="btnStart" class="btn primary" aria-controls="map" aria-label="Start walk">‚ñ∂ Start walk</button>
    <button id="btnLock" class="btn hidden" aria-controls="map" aria-label="Lock onto your location">üìç Lock on me</button>
    <button id="btnEnd" class="btn danger hidden" aria-label="End walk and return home">‚èπ End walk</button>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // --- Map setup ---
    const map = L.map('map', {
      zoomControl: true,
      worldCopyJump: true,
      maxBoundsViscosity: 0.75
    });

    const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Layers
    let routeLayer = L.geoJSON(null, {
      style: {
        color: '#1769ff',
        weight: 5,
        opacity: 0.9
      }
    }).addTo(map);

    // User location visuals
    let userMarker = null; // L.CircleMarker
    let accuracyCircle = null; // L.Circle

    // State flags
    let followingUser = false;
    let watchId = null;
    let lastCoords = null;

    // UI elements
    const btnStart = document.getElementById('btnStart');
    const btnLock  = document.getElementById('btnLock');
    const btnEnd   = document.getElementById('btnEnd');
    const toast    = document.getElementById('toast');

    function showToast(msg, isError=false) {
      toast.textContent = msg;
      toast.classList.toggle('error', !!isError);
      toast.classList.remove('hidden');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.add('hidden'), 3500);
    }

    // Load and display GeoJSON route, then fit bounds
    fetch('/static/routes/Line_3.geojson', {cache: 'no-store'})
      .then(r => {
        if (!r.ok) throw new Error('Failed to load route (' + r.status + ')');
        return r.json();
      })
      .then(geojson => {
        routeLayer.clearLayers();
        routeLayer.addData(geojson);
        try {
          const b = routeLayer.getBounds();
          if (b.isValid()) map.fitBounds(b.pad(0.15));
          else map.setView([0,0], 2);
        } catch (e) {
          map.setView([0,0], 2);
        }
      })
      .catch(err => {
        console.error(err);
        showToast('Could not load the route. Check /static/routes/path.geojson', true);
        map.setView([0,0], 2);
      });

    // If the user manually pans/zooms, pause following
    ['dragstart', 'zoomstart', 'movestart'].forEach(evt => {
      map.on(evt, () => {
        if (followingUser) {
          followingUser = false;
          btnLock.classList.remove('hidden');
        }
      });
    });

    function ensureUserLayers() {
      if (!userMarker) {
        userMarker = L.circleMarker([0,0], {
          radius: 8,
          weight: 2,
          color: '#ffffff',
          fillColor: '#2ecc71',
          fillOpacity: 0.9
        }).addTo(map);
      }
      if (!accuracyCircle) {
        accuracyCircle = L.circle([0,0], { radius: 0, color: '#2ecc71', weight: 1, opacity: 0.3, fillOpacity: 0.08 }).addTo(map);
      }
    }

    function updateUserLocation(position) {
      const { latitude, longitude, accuracy } = position.coords;
      lastCoords = [latitude, longitude];
      ensureUserLayers();
      userMarker.setLatLng(lastCoords);
      accuracyCircle.setLatLng(lastCoords).setRadius(Math.max(accuracy || 0, 5));

      if (followingUser) {
        // Keep a slightly closer zoom for walking
        const targetZoom = Math.max(map.getZoom(), 17);
        map.setView(lastCoords, Math.min(targetZoom, 19), { animate: true });
      }
    }

    function geolocationError(err) {
      console.error(err);
      let msg = 'Location error';
      if (err && typeof err.code === 'number') {
        if (err.code === 1) msg = 'Permission denied for location.';
        if (err.code === 2) msg = 'Location unavailable.';
        if (err.code === 3) msg = 'Location timeout.';
      }
      showToast(msg, true);
    }

    function startFollowing() {
      if (!('geolocation' in navigator)) {
        showToast('Geolocation is not supported on this device/browser.', true);
        return;
      }
      followingUser = true;
      btnStart.classList.add('hidden');
      btnLock.classList.add('hidden');
      btnEnd.classList.remove('hidden');
      showToast('Starting walk‚Ä¶');

      // Begin watching position
      if (watchId !== null) navigator.geolocation.clearWatch(watchId);
      watchId = navigator.geolocation.watchPosition(updateUserLocation, geolocationError, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 15000
      });
    }

    function lockOnUser() {
      if (!lastCoords) {
        showToast('No location fix yet.');
        return;
      }
      followingUser = true;
      btnLock.classList.add('hidden');
      map.setView(lastCoords, Math.max(map.getZoom(), 17), { animate: true });
    }

    function endWalk() {
      followingUser = false;
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      // Optional: clean user layers (kept if you prefer returning with them on map)
      // if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
      // if (accuracyCircle) { map.removeLayer(accuracyCircle); accuracyCircle = null; }

      // Redirect to home route in Flask
      window.location.href = '/';
    }

    // Hook up buttons
    btnStart.addEventListener('click', startFollowing);
    btnLock.addEventListener('click', lockOnUser);
    btnEnd.addEventListener('click', endWalk);

    // Improve first interaction on iOS by requesting one locate attempt (not watched)
    // so Safari can show the permission prompt before the user hits Start.
    (function primeLocateOnce(){
      if (!('geolocation' in navigator)) return;
      const id = navigator.geolocation.getCurrentPosition(
        (pos)=>{ /* noop */ },
        (err)=>{ /* noop */ },
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
      );
    })();
  </script>
</body>
</html>
